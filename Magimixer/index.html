<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>매지믹서</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #level-selector {
            margin-bottom: 0px;
            border-bottom: 3px solid #eee;
            padding-bottom: 20px;
        }
        #level-selector button {
            width: 80px;
            height: 45px;
            padding: 0px;
            font-size: 18px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 0 5px;
            background-color: white;
            transition: all 0.2s ease-in-out;
        }
        #level-selector button:hover {
            background-color: #f0f0f0;
        }
        #level-selector button.active {
            background-color: #007BFF;
            color: white;
            border-color: #007BFF;
            font-weight: bold;
        }
        .button-container {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            max-width: 800px;
            overflow-x: auto;
        }
        button {
            padding: 0px;
            font-size: 20px;
            cursor: pointer;
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 5px;
            margin: 0px;
            flex-shrink: 0;
        }
        .button_e {
            padding: 0px;
            font-size: 20px;
            cursor: pointer;
            width: 140px;
            height: 40px;
            border: none;
            border-radius: 5px;
            margin: 0px;
            background-color: rgb(134, 190, 255);
        }
        .button_new {
            padding: 0px;
            font-size: 20px;
            cursor: pointer;
            width: 140px;
            height: 40px;
            border: none;
            border-radius: 5px;
            margin: 0px;
            background-color: #eee;
        }
        .primary {
            background-color: #007BFF;
            color: white;
        }
        .secondary {
            background-color: #28A745;
            color: white;
        }
        .disabled {
            background-color: #6c757d;
            color: #fff;
            cursor: not-allowed;
        }
        #display {
            margin-top: 20px;
            font-size: 20px;
            text-align: left;
            width: 100%;
            max-width: 600px;
            position: relative;
            left: 60px;
        }
        #display div {
            margin-bottom: 5px;
            min-height: 24px;
        }
        /* 입력란 강조 스타일 */
        #input-display {
            border: 2px solid #007BFF;
            background-color: #f0f8ff;
            width: 460px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #333;
            position: relative;
            left: 0px;
        }
        /* 틀렸을 경우 빨간색 표시 스타일 */
        .error-message {
            color: red;
            font-weight: bold;
        }
        /* 맞았을 경우 녹색 표시 스타일 */
        .correct-message {
            color: green;
            font-weight: bold;
        }
        .line-break {
            width: 100%;
            margin: 10px 0;
        }
        #button-container, #operator-container {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        #operator-container {
            margin-top: 10px;
            flex-direction: column;
            align-items: center;
        }
        .operator-row {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    
    <div id="level-selector">
        <button id="level-easy">초급</button>
        <button id="level-medium">중급</button>
        <button id="level-hard">고급</button>
    </div>

    <h2 id="game-title"></h2>

    <div id="button-container" class="button-container"></div>
    <div class="line-break"></div>
    <div id="operator-container"></div>
    <div id="display">
        <div id="input-display">입력: </div><br>
        <div id="result-display">결과: </div>
    </div>

    <div id="instructions">
        <p id="instruction-text" style="font-size: 18px;"></p>
    </div>
    <div style="font-size: 18px;">
        ◈ 키보드<br>
        숫자, 연산기호, Backspace 모두 사용 가능<br>
        C (초기화): C, Esc<br>
        = (결과확인): Enter, Space<br>
        새로운 문제: R
    </div>

    <a href="example.html" style="
    width: 250px;
    padding: 20px;
    border: 1px solid #333;
    border-radius: 12px;
    background-color: #ffffff;
    text-align: center;
    font-family: sans-serif;
    font-size: 20px;
    margin: 50px auto;
    text-decoration: none;
    color: #000;
  ">
    문제 설명
  </a>

    <script>
        const easyBtn = document.getElementById('level-easy');
        const mediumBtn = document.getElementById('level-medium');
        const hardBtn = document.getElementById('level-hard');
        
        let currentLevel = 'easy';

        function updateActiveButton() {
            easyBtn.classList.remove('active');
            mediumBtn.classList.remove('active');
            hardBtn.classList.remove('active');
            if (currentLevel === 'easy') easyBtn.classList.add('active');
            else if (currentLevel === 'medium') mediumBtn.classList.add('active');
            else hardBtn.classList.add('active');
        }

        // --- 추가: 숫자와 ( 사이에 *를 자동으로 넣어주는 함수 ---
        function insertImplicitMultiplication(expr) {
            // 그리고 닫는괄호 다음에 숫자가 오면 *를 넣어줌

            // 1. 토큰 분리
            let tokens = expr.split(' ').filter(t => t.length > 0);
            let result = [];
            for (let i = 0; i < tokens.length; i++) {
                result.push(tokens[i]);
                // 현재 토큰이 숫자 또는 ')' 이고, 다음 토큰이 '(' 이면 * 삽입
                if (
                    i < tokens.length - 1 &&
                    (
                        (!isNaN(tokens[i]) && tokens[i] !== '') || tokens[i] === ')'
                    ) &&
                    tokens[i + 1] === '('
                ) {
                    result.push('*');
                }
                // 현재 토큰이 ')' 이고, 다음 토큰이 숫자이면 * 삽입
                if (
                    i < tokens.length - 1 &&
                    tokens[i] === ')' &&
                    !isNaN(tokens[i + 1]) && tokens[i + 1] !== ''
                ) {
                    result.push('*');
                }
            }
            return result.join(' ');
        }

        function startGame(level) {
            currentLevel = level;
            updateActiveButton();

            const buttonContainer = document.getElementById('button-container');
            const operatorContainer = document.getElementById('operator-container');
            const inputDisplay = document.getElementById('input-display');
            const resultDisplay = document.getElementById('result-display');
            const gameTitle = document.getElementById('game-title');
            const instructionText = document.getElementById('instruction-text');
            const display = document.getElementById('display');

            buttonContainer.innerHTML = '';
            operatorContainer.innerHTML = '';
            inputDisplay.textContent = '입력: ';
            resultDisplay.textContent = '결과: ';
            resultDisplay.classList.remove('error-message', 'correct-message');
            // '새로운 문제' 시작 시에만 이전 정답 기록을 모두 삭제
            const oldAnswers = display.querySelectorAll('.answer');
            oldAnswers.forEach(div => div.remove());

            let firstButtonOptions, otherButtonMax, title, instructions, useAllNumbers;
            let isSolved = false;

            if (level === 'easy') {
                firstButtonOptions = [10, 20, 30, 40, 50, 60];
                otherButtonMax = 6;
                title = '매지믹서(초급)';
                instructions = '□ 초록색 5개 숫자를 이용하여 파란색 2개 숫자를 더한 수를 만드세요.<br>(단, 초록색 5개 숫자 중 일부만 이용해도 됩니다.)';
                useAllNumbers = false;
            } else if (level === 'medium') {
                firstButtonOptions = [10, 20, 30, 40, 50, 60];
                otherButtonMax = 6;
                title = '매지믹서(중급)';
                instructions = '□ 초록색 5개 숫자를 이용하여 파란색 2개 숫자를 더한 수를 만드세요.<br>(단, 초록색 5개를 모두 이용해야 합니다.)';
                useAllNumbers = true;
            } else { // hard
                firstButtonOptions = [10, 20, 30, 40, 50, 60, 70, 80, 90];
                otherButtonMax = 9;
                title = '매지믹서(고급)';
                instructions = '□ 초록색 5개 숫자를 이용하여 파란색 2개 숫자를 더한 수를 만드세요.<br>(단, 초록색 5개를 모두 이용해야 합니다.)';
                useAllNumbers = true;
            }

            gameTitle.textContent = title;
            document.title = title;
            instructionText.innerHTML = instructions;

            document.addEventListener('contextmenu', e => e.preventDefault());

            const firstButtonValue = firstButtonOptions[Math.floor(Math.random() * firstButtonOptions.length)];
            const otherButtons = Array.from({ length: 6 }, () => Math.floor(Math.random() * otherButtonMax) + 1);
            const numberButtons = [firstButtonValue, ...otherButtons];

            const operators = ['+', '-', '*', '/', '(', ')', '^'];
            let currentInput = '';
            const buttons = [];

            // --- 추가: 초록색 숫자 추적용 배열 ---
            let usedGreenNumbers = [];

            const enterNumberMode = () => {
                buttons.forEach(btn => {
                    if (btn.classList.contains('temp-disabled')) {
                        btn.disabled = false;
                        btn.classList.remove('temp-disabled');
                    }
                });
            };

            const enterOperatorMode = () => {
                buttons.forEach((btn, idx) => {
                    if (idx >= 2 && !btn.classList.contains('disabled')) {
                        btn.disabled = true;
                        btn.classList.add('temp-disabled');
                    }
                });
            };

            numberButtons.forEach((num, index) => {
                const button = document.createElement('button');
                button.textContent = num;

                if (index < 2) {
                    button.classList.add('primary');
                    button.disabled = true;
                } else {
                    button.classList.add('secondary');
                    button.addEventListener('click', () => {
                        // ▼▼▼▼▼ 수정된 부분 ▼▼▼▼▼
                        if (isSolved) {
                            // 결과 메시지만 초기화하고, 이전 정답 기록('정답: ')은 남겨둠
                            resultDisplay.textContent = '결과: ';
                            resultDisplay.classList.remove('error-message', 'correct-message');
                            isSolved = false;
                        }
                        // ▲▲▲▲▲ 수정된 부분 ▲▲▲▲▲
                        if (!button.disabled) {
                            currentInput += num;
                            inputDisplay.textContent = `입력: ${currentInput}`;
                            button.disabled = true;
                            button.classList.remove('secondary');
                            button.classList.add('disabled');
                            // --- 초록색 숫자 사용 기록 ---
                            usedGreenNumbers.push(num);
                            enterOperatorMode();
                        }
                    });
                }
                buttonContainer.appendChild(button);
                buttons.push(button);
            });

            // ---- 연산자 버튼 7개는 첫 줄, 나머지는 두 번째 줄에 표시 ----
            // 첫 줄: 연산자 7개
            const operatorRow1 = document.createElement('div');
            operatorRow1.className = 'operator-row';
            // 두 번째 줄: 나머지 버튼들 (C, ←, =, 새로운 문제)
            const operatorRow2 = document.createElement('div');
            operatorRow2.className = 'operator-row';

            // 연산자 버튼 7개
            operators.forEach(op => {
                const button = document.createElement('button');
                button.textContent = op;
                button.addEventListener('click', () => {
                    currentInput += ` ${op} `;
                    inputDisplay.textContent = `입력: ${currentInput}`;
                    enterNumberMode();
                });
                operatorRow1.appendChild(button);
            });

            // C 버튼
            const resetButton = document.createElement('button');
            resetButton.textContent = 'C';
            resetButton.addEventListener('click', () => {
                currentInput = '';
                inputDisplay.textContent = '입력: ';
                resultDisplay.textContent = '결과: ';
                resultDisplay.classList.remove('error-message', 'correct-message');
                isSolved = false;
                buttons.forEach((btn, index) => {
                    if (index >= 2) {
                        btn.disabled = false;
                        btn.classList.remove('disabled', 'temp-disabled');
                        btn.classList.add('secondary');
                    }
                });
                // --- 초기화 시 사용한 초록색 숫자 기록도 초기화 ---
                usedGreenNumbers = [];
            });
            operatorRow2.appendChild(resetButton);

            // ← 버튼
            const backspaceButton = document.createElement('button');
            backspaceButton.textContent = '←';
            backspaceButton.addEventListener('click', () => {
                const tokens = currentInput.trim().split(' ');
                if (tokens.length === 0 || (tokens.length === 1 && tokens[0] === '')) return;

                const lastToken = tokens.pop();
                currentInput = tokens.join(' ') + (tokens.length > 0 ? ' ' : '');
                
                if (!isNaN(lastToken)) {
                    const lastNumber = Number(lastToken);
                    let foundButton = false;
                    for (let i = buttons.length - 1; i >= 2; i--) {
                        const btn = buttons[i];
                        if (Number(btn.textContent) === lastNumber && btn.classList.contains('disabled') && !foundButton) {
                            btn.disabled = false;
                            btn.classList.remove('disabled');
                            btn.classList.add('secondary');
                            foundButton = true;
                            break;
                        }
                    }
                    // --- 사용한 초록색 숫자에서 마지막 숫자 제거 ---
                    for (let i = usedGreenNumbers.length - 1; i >= 0; i--) {
                        if (usedGreenNumbers[i] === lastNumber) {
                            usedGreenNumbers.splice(i, 1);
                            break;
                        }
                    }
                    enterNumberMode();
                }
                inputDisplay.textContent = `입력: ${currentInput}`;
            });
            operatorRow2.appendChild(backspaceButton);

            // = 버튼
            const calcButton = document.createElement('button');
            calcButton.textContent = '=';
            calcButton.classList.add('button_e');
            calcButton.addEventListener('click', () => {
                if (isSolved) {
                    return;
                }
                
                if (useAllNumbers) {
                    // 모든 초록색 숫자가 사용되었는지 확인
                    // 초록색 숫자 목록
                    const greenNumbers = numberButtons.slice(2);
                    // 사용된 초록색 숫자 카운트
                    const usedCount = {};
                    usedGreenNumbers.forEach(n => {
                        usedCount[n] = (usedCount[n] || 0) + 1;
                    });
                    let allUsed = true;
                    for (let n of greenNumbers) {
                        if (!usedCount[n]) {
                            allUsed = false;
                            break;
                        }
                        // 중복 숫자 처리: 해당 숫자가 여러 번 있으면, 사용된 개수 >= 버튼 개수여야 함
                        const btnCount = greenNumbers.filter(x => x === n).length;
                        if (usedCount[n] < btnCount) {
                            allUsed = false;
                            break;
                        }
                    }
                    if (!allUsed) {
                        resultDisplay.classList.remove('correct-message');
                        resultDisplay.classList.add('error-message');
                        resultDisplay.textContent = '결과: 모든 초록색 숫자를 사용하세요.';
                        return;
                    }
                }

                try {
                    if (currentInput.trim() === '') {
                        resultDisplay.classList.remove('correct-message');
                        resultDisplay.classList.add('error-message');
                        resultDisplay.textContent = '결과: 잘못된 수식입니다.';
                        return;
                    }
                    // --- 여기서 숫자와 ( 사이에 *를 자동으로 넣어줌 ---
                    let fixedInput = insertImplicitMultiplication(currentInput.replace(/\^/g, '**'));
                    const result = eval(fixedInput);

                    const primarySum = buttons
                        .filter(btn => btn.classList.contains('primary'))
                        .reduce((sum, btn) => sum + Number(btn.textContent), 0);

                    if (result === primarySum) {
                        resultDisplay.classList.remove('error-message');
                        resultDisplay.classList.add('correct-message');
                        const answerDiv = document.createElement('div');
                        answerDiv.classList.add('answer');
                        answerDiv.style.color = '#007BFF';
                        answerDiv.textContent = `정답: ${currentInput.trim()} = ${result}`;
                        display.appendChild(answerDiv);
                        resultDisplay.textContent = `결과: ${result} (정답입니다!)`;
                        isSolved = true;
                        
                        currentInput = '';
                        buttons.forEach((btn, index) => {
                            if (index >= 2) {
                                btn.disabled = false;
                                btn.classList.remove('disabled', 'temp-disabled');
                                btn.classList.add('secondary');
                            }
                        });
                        // 정답 후 사용한 초록색 숫자 기록도 초기화
                        usedGreenNumbers = [];
                    } else {
                        resultDisplay.classList.remove('correct-message');
                        resultDisplay.classList.add('error-message');
                        resultDisplay.textContent = `결과: ${result} (틀렸습니다. 목표값: ${primarySum})`;
                    }
                } catch (e) {
                    resultDisplay.classList.remove('correct-message');
                    resultDisplay.classList.add('error-message');
                    resultDisplay.textContent = '결과: 잘못된 수식입니다.';
                }
            });
            operatorRow2.appendChild(calcButton);

            // 새로운 문제 버튼
            const newProblemButton = document.createElement('button');
            newProblemButton.textContent = '새로운 문제';
            newProblemButton.classList.add('button_new');
            newProblemButton.addEventListener('click', () => startGame(currentLevel));
            operatorRow2.appendChild(newProblemButton);

            // operator-container에 두 줄 추가
            operatorContainer.appendChild(operatorRow1);
            operatorContainer.appendChild(operatorRow2);
            
            window.onkeydown = null;
            window.onkeydown = (e) => {
                let handled = false;

                if (e.key >= '0' && e.key <= '9') {
                    const targetButton = buttons.find(btn =>
                        btn.textContent === e.key && !btn.disabled && btn.classList.contains('secondary')
                    );
                    if (targetButton) {
                        targetButton.click();
                        handled = true;
                    }
                }
                else if (['+', '-', '*', '/', '(', ')', '^'].includes(e.key)) {
                    // operatorRow1의 버튼들만 탐색
                    const opButtons = Array.from(operatorRow1.children);
                    const opTarget = opButtons.find(btn => btn.textContent === e.key);
                    if (opTarget) {
                        opTarget.click();
                        handled = true;
                    }
                }
                else {
                    switch (e.key) {
                        case 'c':
                        case 'C':
                        case 'Escape':
                            resetButton.click();
                            handled = true;
                            break;
                        case 'Backspace':
                            backspaceButton.click();
                            handled = true;
                            break;
                        case 'Enter':
                        case ' ':
                            calcButton.click();
                            handled = true;
                            break;
                        case 'r':
                        case 'R':
                            newProblemButton.click();
                            handled = true;
                            break;
                    }
                    if (e.code === 'NumpadEnter') {
                         calcButton.click();
                         handled = true;
                    }
                }

                if (handled) {
                    e.preventDefault();
                }
            };
        }

        easyBtn.addEventListener('click', () => startGame('easy'));
        mediumBtn.addEventListener('click', () => startGame('medium'));
        hardBtn.addEventListener('click', () => startGame('hard'));

        startGame('easy');
    </script>
</body>
</html>