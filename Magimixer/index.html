<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ë§¤ì§€ë¯¹ì„œ</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            text-align: center;
        }
        #level-selector {
            margin-bottom: 0px;
            border-bottom: 3px solid #eee;
            padding-bottom: 20px;
        }
        #level-selector button {
            width: 80px;
            height: 45px;
            padding: 0px;
            font-size: 18px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 0 5px;
            background-color: white;
            transition: all 0.2s ease-in-out;
        }
        #level-selector button:hover {
            background-color: #f0f0f0;
        }
        #level-selector button.active {
            background-color: #007BFF;
            color: white;
            border-color: #007BFF;
            font-weight: bold;
        }
        .button-container {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            max-width: 800px;
            overflow-x: auto;
        }
        button {
            padding: 0px;
            font-size: 20px;
            cursor: pointer;
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 5px;
            margin: 0px;
            flex-shrink: 0;
        }
        .button_e {
            padding: 0px;
            font-size: 20px;
            cursor: pointer;
            width: 140px;
            height: 40px;
            border: none;
            border-radius: 5px;
            margin: 0px;
            background-color: rgb(134, 190, 255);
        }
        .button_new {
            padding: 0px;
            font-size: 20px;
            cursor: pointer;
            width: 140px;
            height: 40px;
            border: none;
            border-radius: 5px;
            margin: 0px;
            background-color: #eee;
        }
        .primary {
            background-color: #007BFF;
            color: white;
        }
        .secondary {
            background-color: #28A745;
            color: white;
        }
        .disabled {
            background-color: #6c757d;
            color: #fff;
            cursor: not-allowed;
        }
        #display {
            margin-top: 20px;
            font-size: 20px;
            text-align: left;
            width: 100%;
            max-width: 600px;
            position: relative;
            left: 60px;
        }
        #display div {
            margin-bottom: 5px;
            min-height: 24px;
        }
        #input-display {
            border: 2px solid #007BFF;
            background-color: #f0f8ff;
            width: 460px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #333;
            position: relative;
            left: 0px;
        }
        .error-message {
            color: red;
            font-weight: bold;
        }
        .correct-message {
            color: green;
            font-weight: bold;
        }
        .line-break {
            width: 100%;
            margin: 10px 0;
        }
        #button-container, #operator-container {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        #operator-container {
            margin-top: 10px;
            flex-direction: column;
            align-items: center;
        }
        .operator-row {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 8px;
        }
        #score-table {
            margin-top: 40px;
            width: 100%;
            max-width: 500px;
            border-collapse: collapse;
            font-size: 16px;
        }
        #score-table caption {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        #score-table th, #score-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            color: #333;
        }
        #score-table th {
            background-color: #f2f2f2;
            color: #555;
        }
    </style>
</head>
<body role="presentation">
    
    <div id="level-selector">
        <button id="level-easy">ì´ˆê¸‰</button>
        <button id="level-medium">ì¤‘ê¸‰</button>
        <button id="level-hard">ê³ ê¸‰</button>
    </div>

    <h2 id="game-title"></h2>

    <div id="button-container" class="button-container"></div>
    <div class="line-break"></div>
    <div id="operator-container"></div>
    <div id="display">
        <div id="input-display">ì…ë ¥: </div><br>
        <div id="result-display">ê²°ê³¼: </div>
    </div>


    <table id="score-table">
        <caption>ë§¤ì§€ë¯¹ì„œ ëˆ„ì  ê¸°ë¡</caption>
        <thead>
            <tr>
                <th>ìˆ˜ì¤€</th>
                <th>ì´ˆê¸‰</th>
                <th>ì¤‘ê¸‰</th>
                <th>ê³ ê¸‰</th>
            </tr>
        </thead>
        <tbody>
            <tr id="solved-row">
                <td>í•´ê²°í•œ íšŸìˆ˜</td>
                <td id="score-easy-solved">0</td>
                <td id="score-medium-solved">0</td>
                <td id="score-hard-solved">0</td>
            </tr>
            <tr id="failed-row">
                <td>ì‹¤íŒ¨í•œ íšŸìˆ˜</td>
                <td id="score-easy-failed">0</td>
                <td id="score-medium-failed">0</td>
                <td id="score-hard-failed">0</td>
            </tr>
            <tr id="new-problem-row">
                <td>ë¬¸ì œë¥¼ ë°”ê¾¼ íšŸìˆ˜</td>
                <td id="score-easy-new">0</td>
                <td id="score-medium-new">0</td>
                <td id="score-hard-new">0</td>
            </tr>
        </tbody>
    </table>

    <br>

    <div id="instructions">
        <p id="instruction-text" style="font-size: 18px;"></p>
    </div>
    <div style="font-size: 18px;">
        â—ˆ í‚¤ë³´ë“œ<br>
        ìˆ«ì, ì—°ì‚°ê¸°í˜¸, Backspace ëª¨ë‘ ì‚¬ìš© ê°€ëŠ¥<br>
        C (ì´ˆê¸°í™”): C, Esc<br>
        = (ê²°ê³¼í™•ì¸): Enter, Space<br>
        ìƒˆë¡œìš´ ë¬¸ì œ: R
    </div>

    <a href="example.html" style="
        width: 250px;
        padding: 20px;
        border: 1px solid #333;
        border-radius: 12px;
        background-color: #ffffff;
        text-align: center;
        font-family: sans-serif;
        font-size: 20px;
        margin: 50px auto;
        text-decoration: none;
        color: #000;
    ">
        ë¬¸ì œ ì„¤ëª…
    </a>

    <script>
        const easyBtn = document.getElementById('level-easy');
        const mediumBtn = document.getElementById('level-medium');
        const hardBtn = document.getElementById('level-hard');
        
        let currentLevel = null; 

        let score = {
            easy: { solved: 0, failed: 0, new: 0 },
            medium: { solved: 0, failed: 0, new: 0 },
            hard: { solved: 0, failed: 0, new: 0 }
        };

        let lastHighlightedCells = [];

        let currentKeydownHandler = null;
        let currentKeyupHandler = null;

        function initializeScoreTable() {
            const levels = ['easy', 'medium', 'hard'];
            levels.forEach(lvl => {
                ['solved', 'failed', 'new'].forEach(cat => {
                    const id = `score-${lvl}-${cat}`;
                    const cell = document.getElementById(id);
                    cell.textContent = score[lvl][cat];
                    cell.style.color = '#333';
                });
            });
            lastHighlightedCells = [];
        }

        function resetCellColors() {
            const cells = document.querySelectorAll('#score-table td');
            cells.forEach(c => c.style.color = '#333');
            lastHighlightedCells = [];
        }

        function highlightScoreCell(cellId) {
            if (Array.isArray(lastHighlightedCells)) {
                lastHighlightedCells.forEach(c => {
                    if (c && typeof c === 'object') {
                        c.style.color = '#333';
                    }
                });
            } else if (lastHighlightedCells) {
                lastHighlightedCells.style.color = '#333';
            }
            const cell = typeof cellId === "string" ? document.getElementById(cellId) : cellId;
            if (cell) {
                cell.style.color = 'red';
                lastHighlightedCells = [cell];
            } else {
                lastHighlightedCells = [];
            }
        }

        function updateScoreTable(level, category) {
            const id = `score-${level}-${category}`;
            const cell = document.getElementById(id);
            const newValue = score[level][category];
            cell.textContent = newValue;
            highlightScoreCell(id);
        }
        
        function updateActiveButton(level) {
            easyBtn.classList.remove('active');
            mediumBtn.classList.remove('active');
            hardBtn.classList.remove('active');
            if (level === 'easy') easyBtn.classList.add('active');
            else if (level === 'medium') mediumBtn.classList.add('active');
            else if (level === 'hard') hardBtn.classList.add('active');
        }

        function insertImplicitMultiplication(expr) {
            let tokens = expr.split(' ').filter(t => t.length > 0);
            let result = [];
            for (let i = 0; i < tokens.length; i++) {
                result.push(tokens[i]);
                if (
                    i < tokens.length - 1 &&
                    (
                        (!isNaN(tokens[i]) && tokens[i] !== '') || tokens[i] === ')'
                    ) &&
                    tokens[i + 1] === '('
                ) {
                    result.push('*');
                }
                if (
                    i < tokens.length - 1 &&
                    tokens[i] === ')' &&
                    !isNaN(tokens[i + 1]) && tokens[i + 1] !== ''
                ) {
                    result.push('*');
                }
            }
            return result.join(' ');
        }

        // --- ê²Œì„ ì‹œì‘ í•¨ìˆ˜ ---
        function startGame(level) {
            
            // ğŸš¨ğŸš¨ ì´ì „ ë¦¬ìŠ¤ë„ˆ ëª…ì‹œì  ì œê±° ğŸš¨ğŸš¨
            if (currentKeydownHandler) {
                document.removeEventListener('keydown', currentKeydownHandler);
            }
            if (currentKeyupHandler) {
                document.removeEventListener('keyup', currentKeyupHandler);
            }
            
            const buttonContainer = document.getElementById('button-container');
            const operatorContainer = document.getElementById('operator-container');
            const inputDisplay = document.getElementById('input-display');
            const resultDisplay = document.getElementById('result-display');
            const gameTitle = document.getElementById('game-title');
            const instructionText = document.getElementById('instruction-text');
            const display = document.getElementById('display');

            currentLevel = level;
            updateActiveButton(level);

            // í™”ë©´ ë¦¬ì…‹
            buttonContainer.innerHTML = '';
            operatorContainer.innerHTML = '';
            inputDisplay.textContent = 'ì…ë ¥: ';
            resultDisplay.textContent = 'ê²°ê³¼: ';
            resultDisplay.classList.remove('error-message', 'correct-message');
            const oldAnswers = display.querySelectorAll('.answer');
            oldAnswers.forEach(div => div.remove());

            let firstButtonOptions, otherButtonMax, title, instructions, useAllNumbers;
            let isSolved = false;
            let solvedExpressions = [];
            let isProcessing = false; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ í”Œë˜ê·¸

            if (level === 'easy') {
                firstButtonOptions = [10, 20, 30, 40, 50, 60];
                otherButtonMax = 6;
                title = 'ë§¤ì§€ë¯¹ì„œ(ì´ˆê¸‰)';
                instructions = 'â–¡ ì´ˆë¡ìƒ‰ 5ê°œ ìˆ«ìë¥¼ ì´ìš©í•˜ì—¬ íŒŒë€ìƒ‰ 2ê°œ ìˆ«ìë¥¼ ë”í•œ ìˆ˜ë¥¼ ë§Œë“œì„¸ìš”.<br>(ë‹¨, ì´ˆë¡ìƒ‰ 5ê°œ ìˆ«ì ì¤‘ ì¼ë¶€ë§Œ ì´ìš©í•´ë„ ë©ë‹ˆë‹¤.)';
                useAllNumbers = false;
            } else if (level === 'medium') {
                firstButtonOptions = [10, 20, 30, 40, 50, 60];
                otherButtonMax = 6;
                title = 'ë§¤ì§€ë¯¹ì„œ(ì¤‘ê¸‰)';
                instructions = 'â–¡ ì´ˆë¡ìƒ‰ 5ê°œ ìˆ«ìë¥¼ ì´ìš©í•˜ì—¬ íŒŒë€ìƒ‰ 2ê°œ ìˆ«ìë¥¼ ë”í•œ ìˆ˜ë¥¼ ë§Œë“œì„¸ìš”.<br>(ë‹¨, ì´ˆë¡ìƒ‰ 5ê°œë¥¼ ëª¨ë‘ ì´ìš©í•´ì•¼ í•©ë‹ˆë‹¤.)';
                useAllNumbers = true;
            } else { // hard
                firstButtonOptions = [10, 20, 30, 40, 50, 60, 70, 80, 90];
                otherButtonMax = 9;
                title = 'ë§¤ì§€ë¯¹ì„œ(ê³ ê¸‰)';
                instructions = 'â–¡ ì´ˆë¡ìƒ‰ 5ê°œ ìˆ«ìë¥¼ ì´ìš©í•˜ì—¬ íŒŒë€ìƒ‰ 2ê°œ ìˆ«ìë¥¼ ë”í•œ ìˆ˜ë¥¼ ë§Œë“œì„¸ìš”.<br>(ë‹¨, ì´ˆë¡ìƒ‰ 5ê°œë¥¼ ëª¨ë‘ ì´ìš©í•´ì•¼ í•©ë‹ˆë‹¤.)';
                useAllNumbers = true;
            }

            gameTitle.textContent = title;
            document.title = title;
            instructionText.innerHTML = instructions;

            document.addEventListener('contextmenu', e => e.preventDefault());

            const primary1 = firstButtonOptions[Math.floor(Math.random() * firstButtonOptions.length)];
            const primary2 = Math.floor(Math.random() * otherButtonMax) + 1;
            const secondaryButtons = Array.from({ length: 5 }, () => Math.floor(Math.random() * otherButtonMax) + 1);

            const buttons = [];
            const numberButtonsArray = [primary1, primary2, ...secondaryButtons];

            let currentInput = '';
            let usedGreenNumbers = [];

            const enterNumberMode = () => {
                buttons.forEach(btn => {
                    if (btn.classList.contains('temp-disabled')) {
                        btn.disabled = false;
                        btn.classList.remove('temp-disabled');
                    }
                });
            };

            const enterOperatorMode = () => {
                buttons.forEach((btn, idx) => {
                    if (idx >= 2 && !btn.classList.contains('disabled')) {
                        btn.disabled = true;
                        btn.classList.add('temp-disabled');
                    }
                });
            };

            numberButtonsArray.forEach((num, index) => {
                const button = document.createElement('button');
                button.textContent = num;

                if (index < 2) { 
                    button.classList.add('primary');
                    button.disabled = true;
                } else { 
                    button.classList.add('secondary');
                    button.addEventListener('click', () => {
                        if (isSolved) {
                            resultDisplay.textContent = 'ê²°ê³¼: ';
                            resultDisplay.classList.remove('error-message', 'correct-message');
                            isSolved = false;
                        }
                        if (!button.disabled) {
                            currentInput += num;
                            inputDisplay.textContent = `ì…ë ¥: ${currentInput}`;
                            button.disabled = true;
                            button.classList.remove('secondary');
                            button.classList.add('disabled');
                            usedGreenNumbers.push(num);
                            enterOperatorMode();
                        }
                    });
                }
                buttonContainer.appendChild(button);
                buttons.push(button);
            });

            const operators = ['+', '-', '*', '/', '(', ')', '^'];
            const operatorRow1 = document.createElement('div');
            operatorRow1.className = 'operator-row';
            const operatorRow2 = document.createElement('div');
            operatorRow2.className = 'operator-row';

            operators.forEach(op => {
                const button = document.createElement('button');
                button.textContent = op;
                button.addEventListener('click', () => {
                    currentInput += ` ${op} `;
                    inputDisplay.textContent = `ì…ë ¥: ${currentInput}`;
                    enterNumberMode();
                });
                operatorRow1.appendChild(button);
            });

            // C ë²„íŠ¼
            const resetButton = document.createElement('button');
            resetButton.textContent = 'C';
            resetButton.addEventListener('click', () => {
                currentInput = '';
                inputDisplay.textContent = 'ì…ë ¥: ';
                resultDisplay.textContent = 'ê²°ê³¼: ';
                resultDisplay.classList.remove('error-message', 'correct-message');
                isSolved = false;
                buttons.forEach((btn, index) => {
                    if (index >= 2) {
                        btn.disabled = false;
                        btn.classList.remove('disabled', 'temp-disabled');
                        btn.classList.add('secondary');
                    }
                });
                usedGreenNumbers = [];
            });
            operatorRow2.appendChild(resetButton);

            // â† ë²„íŠ¼
            const backspaceButton = document.createElement('button');
            backspaceButton.textContent = 'â†';
            backspaceButton.addEventListener('click', () => {
                const tokens = currentInput.trim().split(' ');
                if (tokens.length === 0 || (tokens.length === 1 && tokens[0] === '')) return;

                const lastToken = tokens.pop();
                currentInput = tokens.join(' ') + (tokens.length > 0 ? ' ' : '');
                
                if (!isNaN(lastToken)) {
                    const lastNumber = Number(lastToken);
                    let foundButton = false;
                    for (let i = buttons.length - 1; i >= 2; i--) {
                        const btn = buttons[i];
                        if (Number(btn.textContent) === lastNumber && btn.classList.contains('disabled') && !foundButton) {
                            btn.disabled = false;
                            btn.classList.remove('disabled');
                            btn.classList.add('secondary');
                            foundButton = true;
                            break;
                        }
                    }
                    for (let i = usedGreenNumbers.length - 1; i >= 0; i--) {
                        if (Number(usedGreenNumbers[i]) === lastNumber) {
                            usedGreenNumbers.splice(i, 1);
                            break;
                        }
                    }
                    enterNumberMode();
                }
                inputDisplay.textContent = `ì…ë ¥: ${currentInput}`;
            });
            operatorRow2.appendChild(backspaceButton);

            // --- ê²Œì„ ê²°ê³¼ ì²˜ë¦¬ ë° ì‹¤íŒ¨ ì¹´ìš´íŠ¸ í†µí•© í•¨ìˆ˜ ---
            const handleGameResult = (isSuccess, message, expression = null, resultValue = null) => {
                
                if (message.includes('ê³„ì‚° ë¶ˆê°€') || message.includes('ì…ë ¥ ì—†ìŒ') || message.includes('ë™ì¼í•œ ê²°ê³¼') || message.includes('ëª¨ë“  ì´ˆë¡ìƒ‰')) {
                    resultDisplay.classList.remove('correct-message');
                    resultDisplay.classList.add('error-message');
                    resultDisplay.textContent = `ê²°ê³¼: ${message}`;
                    if(message.includes('ë™ì¼í•œ ê²°ê³¼')) isSolved = true;
                    return;
                }

                if (isSuccess) {
                    score[currentLevel].solved++;
                    updateScoreTable(currentLevel, 'solved');

                    if (expression) solvedExpressions.push(expression);

                    resultDisplay.classList.remove('error-message');
                    resultDisplay.classList.add('correct-message');
                    const answerDiv = document.createElement('div');
                    answerDiv.classList.add('answer');
                    answerDiv.style.color = '#007BFF';
                    answerDiv.textContent = `ì •ë‹µ: ${expression} = ${resultValue}`;
                    display.appendChild(answerDiv);
                    resultDisplay.textContent = `ê²°ê³¼: ${resultValue} (ì •ë‹µì…ë‹ˆë‹¤!)`;
                    isSolved = true;

                    currentInput = '';
                    buttons.forEach((btn, index) => {
                        if (index >= 2) {
                            btn.disabled = false;
                            btn.classList.remove('disabled', 'temp-disabled');
                            btn.classList.add('secondary');
                        }
                    });
                    usedGreenNumbers = [];
                } 
                
                else {
                    // âŒ ì‹¤íŒ¨ íšŸìˆ˜ ì¦ê°€ (ì˜¤ì§ ì—¬ê¸°ì„œë§Œ 1íšŒ ì¦ê°€)
                    score[currentLevel].failed++;
                    updateScoreTable(currentLevel, 'failed');
                    
                    resultDisplay.classList.remove('correct-message');
                    resultDisplay.classList.add('error-message');
                    resultDisplay.textContent = `ê²°ê³¼: ${message}`;
                }
            };
            
            // ğŸš¨ğŸš¨ ë‹¨ì¼ ê³„ì‚° ë¡œì§ í•¨ìˆ˜ ğŸš¨ğŸš¨
            const calcLogic = () => {
                if (isSolved) {
                    return;
                }

                if (isProcessing) {
                    return;
                }
                isProcessing = true;
                
                resetCellColors();

                const normalizedInput = currentInput.trim();
                const primarySum = Number(buttons[0].textContent) + Number(buttons[1].textContent);
                
                try { 

                    // 1. ë¹ˆ ì…ë ¥ í™•ì¸
                    if (normalizedInput === '') {
                        handleGameResult(false, 'ì˜ëª»ëœ ìˆ˜ì‹ì…ë‹ˆë‹¤. (ì…ë ¥ ì—†ìŒ)');
                        return;
                    }
                    
                    // 2. ìˆ˜ì‹ ê³„ì‚° ì‹œë„ (ì¡°ê±´ 1: ê³„ì‚° ê°€ëŠ¥ ì—¬ë¶€)
                    let result;
                    try {
                        let fixedInput = insertImplicitMultiplication(normalizedInput.replace(/\^/g, '**'));
                        result = eval(fixedInput);
                        
                        if (typeof result !== 'number' || !isFinite(result)) {
                            throw new Error("Invalid calculation result");
                        }
                    } catch (e) {
                        // âŒ ìˆ˜ì‹ì´ ì˜ëª»ëœ ê²½ìš° (3+, 5**, ë“±)
                        handleGameResult(false, 'ì˜ëª»ëœ ìˆ˜ì‹ì…ë‹ˆë‹¤. (ê³„ì‚° ë¶ˆê°€)');
                        return; 
                    }
                    
                    // 3. ì´ˆë¡ìƒ‰ ìˆ«ì ëª¨ë‘ ì‚¬ìš© ì—¬ë¶€ í™•ì¸ (ì¤‘ê¸‰/ê³ ê¸‰) - ìˆ˜ì‹ ê³„ì‚° ì„±ê³µ í›„ ê²€ì‚¬
                    if (useAllNumbers) {
                        const greenButtons = buttons.slice(2);
                        const greenNumbers = greenButtons.map(btn => Number(btn.textContent));
                        
                        const greenButtonCounts = {};
                        greenNumbers.forEach(n => {
                            greenButtonCounts[n] = (greenButtonCounts[n] || 0) + 1;
                        });
                        
                        const usedCount = {};
                        usedGreenNumbers.forEach(n => {
                            usedCount[n] = (usedCount[n] || 0) + 1;
                        });
                        
                        let allUsed = true;
                        for (const n in greenButtonCounts) {
                            if ((usedCount[n] || 0) < greenButtonCounts[n]) {
                                allUsed = false;
                                break;
                            }
                        }
                        
                        if (!allUsed) {
                            // âŒ ìˆ˜ì‹ì€ ê³„ì‚°ë˜ì—ˆì§€ë§Œ ìˆ«ì ì¡°ê±´ ë¯¸ë‹¬
                            handleGameResult(false, 'ëª¨ë“  ì´ˆë¡ìƒ‰ ìˆ«ìë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.');
                            return; 
                        }
                    }
                    
                    // 4. ê²°ê³¼ê°’ í™•ì¸
                    if (result === primarySum) {
                        if (solvedExpressions.includes(normalizedInput)) {
                            handleGameResult(false, 'ë™ì¼í•œ ê²°ê³¼ê°€ ìˆìŠµë‹ˆë‹¤.');
                            return;
                        }

                        handleGameResult(true, 'ì •ë‹µì…ë‹ˆë‹¤!', normalizedInput, result);

                    } else {
                        handleGameResult(false, `${result} (í‹€ë ¸ìŠµë‹ˆë‹¤. ëª©í‘œê°’: ${primarySum})`);
                    }

                } finally {
                    isProcessing = false;
                }
            }


            // = ë²„íŠ¼
            const calcButton = document.createElement('button');
            calcButton.textContent = '=';
            calcButton.classList.add('button_e');
            calcButton.addEventListener('click', calcLogic); 
            operatorRow2.appendChild(calcButton);

            // ìƒˆë¡œìš´ ë¬¸ì œ ë²„íŠ¼
            const newProblemButton = document.createElement('button');
            newProblemButton.textContent = 'ìƒˆë¡œìš´ ë¬¸ì œ';
            newProblemButton.classList.add('button_new');
            newProblemButton.addEventListener('click', () => {
                resetCellColors();

                // ğŸš¨ğŸš¨ ìƒˆë¡œìš´ ë¬¸ì œ ë²„íŠ¼ í´ë¦­ ì‹œ, í˜„ì¬ ë ˆë²¨ì˜ ì¹´ìš´íŠ¸ë¥¼ ì¦ê°€ì‹œí‚µë‹ˆë‹¤. ğŸš¨ğŸš¨
                if (currentLevel) {
                    score[currentLevel].new++;
                    updateScoreTable(currentLevel, 'new');
                }
                startGame(currentLevel);
            });
            operatorRow2.appendChild(newProblemButton);

            operatorContainer.appendChild(operatorRow1);
            operatorContainer.appendChild(operatorRow2);
            
            // ğŸš¨ğŸš¨ ê²Œì„ ì‹œì‘ ì‹œ calcButtonì— í¬ì»¤ìŠ¤ ê°•ì œ ì„¤ì • ğŸš¨ğŸš¨
            calcButton.focus();

            // ğŸš¨ğŸš¨ Keydown í•¸ë“¤ëŸ¬ í•¨ìˆ˜ ì •ì˜ ë° ë“±ë¡ ğŸš¨ğŸš¨
            currentKeydownHandler = (e) => {
                let handled = false;

                // Enter í‚¤ëŠ” keydownì—ì„œ ë¬´ì¡°ê±´ ë§‰ìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ê¸°ë³¸ ë™ì‘ ì°¨ë‹¨ ê°•í™”)
                if (e.key === 'Enter' || e.code === 'NumpadEnter') {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    return; 
                }

                if (e.key >= '0' && e.key <= '9') {
                    const targetButton = buttons.find(btn =>
                        btn.textContent === e.key && !btn.disabled && btn.classList.contains('secondary')
                    );
                    if (targetButton) {
                        targetButton.click();
                        handled = true;
                    }
                }
                else if (['+', '-', '*', '/', '(', ')', '^'].includes(e.key)) {
                    const opButtons = Array.from(operatorRow1.children);
                    const opTarget = opButtons.find(btn => btn.textContent === e.key);
                    if (opTarget) {
                        opTarget.click();
                        handled = true;
                    }
                }
                else {
                    switch (e.key) {
                        case 'c':
                        case 'C':
                        case 'Escape':
                            resetButton.click();
                            handled = true;
                            break;
                        case 'Backspace':
                            backspaceButton.click();
                            handled = true;
                            break;
                    }
                }

                if (handled) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                }
            };

            // ğŸš¨ğŸš¨ Keyup í•¸ë“¤ëŸ¬ í•¨ìˆ˜ ì •ì˜ ë° ë“±ë¡ (Enter, Space, R ì²˜ë¦¬) ğŸš¨ğŸš¨
            currentKeyupHandler = (e) => {
                
                // 1. Enter/Space ì²˜ë¦¬ 
                if (e.key === 'Enter' || e.key === ' ' || e.code === 'NumpadEnter') {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    
                    calcLogic();
                    return;
                }

                // 2. R í‚¤ ì²˜ë¦¬
                if (e.key === 'r' || e.key === 'R') {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    
                    newProblemButton.click();
                    return;
                }
            };

            document.addEventListener('keydown', currentKeydownHandler);
            document.addEventListener('keyup', currentKeyupHandler);
        }

        // ë ˆë²¨ ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œì§
        function handleLevelChange(newLevel) {
            resetCellColors();

            // ğŸš¨ğŸš¨ğŸš¨ ë ˆë²¨ ë³€ê²½ ì‹œ, ìƒˆë¡œ ì‹œì‘í•˜ëŠ” ë ˆë²¨ì˜ 'ë¬¸ì œë¥¼ ë°”ê¾¼ íšŸìˆ˜'ë¥¼ ì¦ê°€ì‹œí‚µë‹ˆë‹¤. ğŸš¨ğŸš¨ğŸš¨
            // ìµœì´ˆ startGame('easy') ì‹œì—ëŠ” currentLevelì´ nullì´ë¯€ë¡œ ì¦ê°€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            if (currentLevel !== null) { 
                score[newLevel].new++; 
                updateScoreTable(newLevel, 'new');
            }

            startGame(newLevel);
        }

        easyBtn.addEventListener('click', () => handleLevelChange('easy'));
        mediumBtn.addEventListener('click', () => handleLevelChange('medium'));
        hardBtn.addEventListener('click', () => handleLevelChange('hard'));

        // ì²« ì‹œì‘
        startGame('easy'); 
        initializeScoreTable();
    </script>
</body>
</html>