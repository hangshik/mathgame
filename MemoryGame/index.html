<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memory Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }
    h1 { margin-top: 20px; }

    #stage-buttons {
      margin: 20px auto;
      display: grid;
      grid-template-columns: repeat(6, auto);
      gap: 5px;
      justify-content: center;
      max-width: 700px;
    }
    .stage-button {
      font-size: 16px;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      cursor: pointer;
      background-color: #f1f3f5;
      color: #495057;
    }
    .stage-button.active {
      background-color: #339af0;
      color: white;
      border-color: #339af0;
    }
    .stage-button.completed {
      background-color: #51cf66;
      color: white;
      border-color: #37b24d;
    }

    #game-board {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      grid-template-rows: repeat(5, 1fr);
      grid-gap: 5px;
      justify-content: center;
      margin: 0 auto 20px auto;
      width: 90vw;
      max-width: 500px;
    }
    .cell {
      width: 50px;
      height: 50px;
      background-color: #cccccc;
      color: #1c78da;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    .cell:hover { background-color: #b3d0ff; }
    .hidden { background-color: #007bff; color: white; }
    .start-circle {
      grid-column: 9;
      grid-row: 5;
      width: 50px;
      height: 50px;
      background-color: #28a745;
      color: white;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 16px;
      cursor: pointer;
    }
    .start-circle.hidden { display: none; }

    #message {
      margin-top: 20px;
      font-size: 18px;
      color: #333;
    }
    @media (max-width: 600px) {
      .cell { width: 40px; height: 40px; font-size: 14px; }
      .start-circle { width: 40px; height: 40px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <h1>Memory Game</h1>
  <div id="stage-buttons"></div>
  <div id="game-board"></div>
  <div id="message"></div>

  <script>
    document.addEventListener('contextmenu', e => e.preventDefault());

    const gameBoard = document.getElementById('game-board');
    const message = document.getElementById('message');

    let sequence = [];
    let userSequence = [];
    let sequenceLength = 5;
    let currentStage = 5;
    let completedStages = new Set();  // ✅ 성공한 단계 기록

    function generateSequence(length) {
      return Array.from({ length }, (_, i) => i + 1);
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function createBoard() {
      gameBoard.innerHTML = '';
      for (let i = 1; i <= 45; i++) {
        const cell = document.createElement('div');
        cell.classList.add('cell');
        cell.dataset.number = i;
        cell.style.display = i === 45 ? 'none' : 'flex';
        cell.addEventListener('click', handleCellClick);
        gameBoard.appendChild(cell);
      }
      const startCircle = document.createElement('div');
      startCircle.classList.add('start-circle');
      startCircle.textContent = 'Start';
      startCircle.addEventListener('click', startGame);
      gameBoard.appendChild(startCircle);
    }

    function startGame() {
      message.textContent = `${sequenceLength}단계를 시작합니다!`;
      sequence = generateSequence(sequenceLength);
      userSequence = [];

      document.querySelector('.start-circle').classList.add('hidden');
      const lastCell = document.querySelector(".cell[data-number='45']");
      if(lastCell) lastCell.style.display='flex';

      const cells = Array.from(document.querySelectorAll('.cell'));
      shuffleArray(cells);
      sequence.forEach((number, index) => {
        const cell = cells[index];
        cell.textContent = number;
        cell.dataset.number = number;
        cell.classList.add('number-cell');
      });
    }

    function handleCellClick(e) {
      const cell = e.target;
      const number = parseInt(cell.dataset.number, 10);
      if (!cell.classList.contains('number-cell') || cell.classList.contains('clicked')) return;

      if (number !== userSequence.length + 1) {
        message.textContent = `실패! ${sequenceLength}단계에서 실패하셨습니다. 다시 시도해보세요!`;
        cell.classList.remove('hidden');
        cell.textContent = number;
        setTimeout(() => createBoard(), 1000);
        return;
      }

      userSequence.push(number);
      if (number === 1) {
        document.querySelectorAll('.number-cell').forEach(cell => {
          cell.classList.add('hidden');
          cell.textContent = '';
        });
      }

      cell.classList.remove('hidden');
      cell.classList.add('clicked');
      cell.textContent = number;

      if (userSequence.length === sequence.length) {
        setTimeout(checkResult, 500);
      }
    }

    function checkResult() {
      const isCorrect = userSequence.every((num, i) => num === i + 1);
      if (isCorrect) {
        message.textContent = `성공! ${sequenceLength}단계를 클리어했습니다!`;
        completedStages.add(sequenceLength);  // ✅ 성공 단계 기록
        sequenceLength++;
        currentStage = sequenceLength;
      } else {
        message.textContent = `실패! ${sequenceLength}단계에서 실패하셨습니다. 다시 시도하세요!`;
      }
      createBoard();
      updateStageButtons();
    }

    function createStageButtons() {
      const container = document.getElementById('stage-buttons');
      container.innerHTML = '';
      for (let i = 5; i <= 22; i++) {   // ✅ 5~22단계
        const btn = document.createElement('button');
        btn.textContent = i + '단계';
        btn.className = 'stage-button';
        if (i === currentStage) btn.classList.add('active');
        if (completedStages.has(i)) btn.classList.add('completed'); // ✅ 성공 단계 녹색
        btn.addEventListener('click', () => {
          currentStage = i;
          sequenceLength = i;
          updateStageButtons();
          createBoard();
        });
        container.appendChild(btn);
      }
    }

    function updateStageButtons() {
      const buttons = document.querySelectorAll('.stage-button');
      buttons.forEach(btn => {
        btn.classList.remove('active');
        const stageNum = parseInt(btn.textContent);
        if (stageNum === currentStage) btn.classList.add('active');
        if (completedStages.has(stageNum)) btn.classList.add('completed');
      });
    }

    createStageButtons();
    createBoard();
  </script>
</body>
</html>
